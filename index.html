<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Zen Dragon Trainer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:Arial;background:#111;color:#eee;margin:0;display:flex;justify-content:center;align-items:center;height:100vh;overflow:hidden}
.hidden{display:none}
.center{display:flex;justify-content:center;align-items:center;height:100%;width:100%}
.card{background:#1c1c1c;padding:20px;border-radius:14px;box-shadow:0 0 25px rgba(0,255,255,.2);text-align:center}
.bigbtn{background:#0af;border:0;padding:14px 20px;border-radius:10px;margin:6px;font-size:18px;cursor:pointer;color:white;font-weight:bold}
.bigbtn:hover{background:#09c}
.btn{background:#444;border:0;padding:10px 14px;border-radius:8px;margin:4px;color:white;cursor:pointer}
.btn:hover{background:#555}
.options{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:20px}
.opt{background:#222;padding:16px;border-radius:12px;cursor:pointer;font-size:22px}
.opt.correct{background:#008c3c}
.opt.wrong{background:#b30000}
.q{font-size:42px;margin:18px}
.topSwitch{cursor:pointer;color:#0af;font-weight:bold;float:right;margin:5px}
.bar{height:6px;background:#333;margin:10px 0;border-radius:6px}
#barFill{display:block;height:100%;width:0;background:#0af;border-radius:6px}
.mini{font-size:14px;margin-top:6px;color:#ccc}
#side{position:absolute;left:0;top:0;width:220px;padding:16px;background:#0009;border-right:1px solid #0af;height:100%;text-align:left}
.metric{margin-bottom:12px}
.label{font-size:12px;color:#aaa}
.value{font-size:20px;font-weight:bold}
.hint{font-size:12px;color:#888;margin-top:10px}
.lock{color:#777}
.ok{color:#0f0;font-weight:bold}
.lockIcon{margin-right:6px}
.shake{animation:shake .3s}
@keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-5px)}50%{transform:translateX(5px)}75%{transform:translateX(-5px)}100%{transform:translateX(0)}}
#summary,#howtoModal{position:absolute;top:0;left:0;width:100%;height:100%;background:#000c;display:none}
.conf{position:fixed;width:8px;height:8px;border-radius:50%;opacity:.9;z-index:9999}
</style>
</head>
<body>

<div id="app"></div>

<script>
const $ = id => document.getElementById(id);
const show = el => {
 ["lobby","combatMenu","practiceMenu","game"].forEach(v=>$(v)?.classList.add("hidden"));
 $(el)?.classList.remove("hidden");
};
function pling(){try{let c=new AudioContext(),o=c.createOscillator(),g=c.createGain();
o.type="sine";o.frequency.value=880;g.gain.value=.0001;o.connect(g).connect(c.destination);o.start();
g.gain.exponentialRampToValueAtTime(.15,c.currentTime+.01);g.gain.exponentialRampToValueAtTime(.0001,c.currentTime+.12);
o.stop(c.currentTime+.13);}catch(e){}}

let MODE='combat', DIFF='easy', TOPIC='m', LENGTH=20;
let qs=[],i=0,score=0,total=0,rts=[],isReview=false;
let combatMistTopics=[],combatSlowTopics=[];
let UNL=JSON.parse(localStorage.getItem('zenUnlocks')||'{"medium":false,"hard":false}');
let COMHIST=JSON.parse(localStorage.getItem('zenCombatSessions')||'[]');
let PMIST=JSON.parse(localStorage.getItem('zenPracticeMistakesV2')||'{"m":[],"pow":[],"root":[],"frac":[]}');
let PCOUNT=JSON.parse(localStorage.getItem('zenPracticeCountsV2')||'{"m":0,"pow":0,"root":0,"frac":[]}');
const saveUnlocks=()=>localStorage.setItem('zenUnlocks',JSON.stringify(UNL));
const saveComHist=()=>localStorage.setItem('zenCombatSessions',JSON.stringify(COMHIST.slice(-6)));
const savePMist=()=>localStorage.setItem('zenPracticeMistakesV2',JSON.stringify(PMIST));
const savePCount=()=>localStorage.setItem('zenPracticeCountsV2',JSON.stringify(PCOUNT));

const rand=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;

const mulPool=(A,B)=>{let out=[];A.forEach(x=>B.forEach(y=>out.push({t:`${x}Ã—${y}`,a:String(x*y),topic:'m'})));return out;}
function powPool(){let o=[];for(let n=1;n<=14;n++)o.push({t:`${n}Â²`,a:String(n*n),topic:'pow'});
for(let n=2;n<=6;n++)o.push({t:`${n}Â³`,a:String(n*n*n),topic:'pow'});
o.push({t:'2â´',a:'16',topic:'pow'},{t:'3â´',a:'81',topic:'pow'},{t:'2âµ',a:'32',topic:'pow'},{t:'2â¶',a:'64',topic:'pow'});return o;}
function rootPool(){let o=[];[4,9,16,25,36,49,64,81,100,121,144,169,196].forEach(v=>o.push({t:`âˆš${v}`,a:String(Math.sqrt(v)),topic:'root'}));
[8,27,64,125,216].forEach(v=>o.push({t:`Â³âˆš${v}`,a:String(Math.cbrt(v)),topic:'root'}));
[16,81].forEach(v=>o.push({t:`â´âˆš${v}`,a:String(Math.round(Math.pow(v,1/4))),topic:'root'}));
o.push({t:'âµâˆš32',a:'2',topic:'root'},{t:'â¶âˆš64',a:'2',topic:'root'});return o;}
function fracPool(){let o=[];for(let k=0;k<14;k++){let a=rand(2,9),b=rand(2,9),c=rand(2,9);let n=a*b,d=a*c;
let g=(m,n)=>{while(n){[m,n]=[n,m%n]}return Math.abs(m)},gg=g(n,d);
let s=(n/gg)+'/'+(d/gg);if(d/gg==1)s=String(n/gg);o.push({t:`${n}/${d}`,a:s,topic:'frac'})}return o;}
function pick4(ans,topic){let s=new Set([ans]),num=parseFloat(ans);while(s.size<4){let g=String((isNaN(num)?rand(2,99):num+rand(-9,9)));
if(g!==ans&&g!=='NaN'&&g!=='0')s.add(g)}return[...s].sort(()=>Math.random()-.5).map(v=>({v,topic}))}
function combatPool(d){
 let set=[];
 if(d==='easy')set=[].concat(mulPool([2,3,4,5],[2,3,4,5,6]),powPool(),rootPool(),fracPool());
 else if(d==='medium')set=[].concat(mulPool([3,4,5,6,7],[4,5,6,7,8,9,10]),powPool(),rootPool(),fracPool());
 else set=[].concat(mulPool([6,7,8,9],[6,7,8,9,10]),powPool(),rootPool(),fracPool());
 return set.sort(()=>Math.random()-.5);
}
const practicePool=topic=>([].concat(combatPool('easy'),combatPool('medium'),combatPool('hard'))).filter(x=>x.topic===topic);

function last3Stats(){let h=COMHIST.slice(-3);if(!h.length)return{acc:null,avg:null,mist:null,weak:null};
return{
 acc:h.reduce((s,x)=>s+(x.acc||0),0)/h.length,
 avg:h.reduce((s,x)=>s+(x.avg||0),0)/h.length,
 mist:h.reduce((s,x)=>s+(x.bank||0),0)/h.length,
 weak:h.map(x=>x.weak||[]).flat()
}}
function drawSideHUD(){
 if(MODE!=='combat')return;
 const s=last3Stats();
 $('hudAcc').textContent=s.acc==null?'â€”':s.acc.toFixed(0)+'%';
 $('hudSpd').textContent=s.avg==null?'â€”':(s.avg/1000).toFixed(2)+'s';
 $('hudBank').textContent=s.mist==null?'â€”':s.mist.toFixed(2);
 let w=s.weak||[];
 $('hudWeak').innerHTML=w.length?w.map(t=>t).join(', '):'â€”';
}

function updateLevelBadge(){
 const cMed=$('cMed'),cHard=$('cHard');
 function lock(btn,flag,icon){
  if(!flag){btn.classList.add('lockedBtn');if(!btn.querySelector('.lockIcon')){let i=document.createElement('span');i.className='lockIcon';i.textContent=icon;btn.prepend(i)}}
  else{btn.classList.remove('lockedBtn');btn.querySelector('.lockIcon')?.remove();}
 }
 lock(cMed,UNL.medium,'ğŸ”’');lock(cHard,UNL.hard,'ğŸ”');
 $('medState').textContent=UNL.medium?'(unlocked)':'(locked)';
 $('medState').className=UNL.medium?'ok':'lock';
 $('hardState').textContent=UNL.hard?'(unlocked)':'(locked)';
 $('hardState').className=UNL.hard?'ok':'lock';
}

function resetRuntime(){i=0;score=0;rts=[];combatMistTopics=[];combatSlowTopics=[];}

function startCombat(diff){
 MODE='combat';DIFF=diff;LENGTH=parseInt($('lenCombat').value||'20');
 qs=combatPool(diff).slice(0,LENGTH);total=qs.length;
 $('gameTitle').textContent=`Combat â€” ${diff}`;
 enterGame(true);
}

function startPractice(topic){
 MODE='practice';TOPIC=topic;LENGTH=parseInt($('lenPractice').value||'20');
 const next=(PCOUNT[TOPIC]||0)+1;isReview=(next%3===0)&&(PMIST[TOPIC]||[]).length>0;
 let pool=isReview?PMIST[TOPIC].slice():practicePool(TOPIC).sort(()=>Math.random()-.5);
 qs=(pool.length>=LENGTH?pool.slice(0,LENGTH):pool.concat(practicePool(TOPIC)).slice(0,LENGTH));
 total=qs.length;
 const map={m:'Multiplication',pow:'Exponents',root:'Roots',frac:'Fractions'};
 $('gameTitle').textContent=isReview?`Practice â€” ${map[TOPIC]} (Review)`: `Practice â€” ${map[TOPIC]}`;
 enterGame(false);
}

function enterGame(side){
 show('game');$('side').style.display=side?'block':'none';
 $('barFill').style.width='0%';$('progress').textContent='0%';resetRuntime();drawSideHUD();
 $('q').style.display=side?'none':'block';$('startWrap').style.display=side?'flex':'none';
 if(!side)render();
}

function render(){
 if(i>=total){end();return}
 const item=qs[i];$('q').textContent=item.t;
 const ops=pick4(item.a,item.topic);
 $('opts').innerHTML=ops.map(o=>`<div class="opt" data-topic="${o.topic}" data-val="${o.v}">${o.v}</div>`).join("");
 [...document.querySelectorAll('.opt')].forEach(el=>el.onclick=()=>pick(el.getAttribute('data-val'),item.a,item));
 $('barFill').style.width=(i/total*100)+'%';$('progress').textContent=Math.round(i/total*100)+'%';window.__t=performance.now();
}
document.onkeydown=e=>{if(['1','2','3','4'].includes(e.key)){let b=document.querySelectorAll('.opt')[parseInt(e.key)-1];if(b)b.click()}};

function ensureMist(topic,item){PMIST[topic]=PMIST[topic]||[];if(!PMIST[topic].some(x=>x.t===item.t))PMIST[topic].push({...item,streak:0});savePMist();}
function markReview(topic,item,ok){let idx=PMIST[topic].findIndex(x=>x.t===item.t);if(idx>-1)PMIST[topic][idx].streak=ok?(PMIST[topic][idx].streak||0)+1:0;savePMist();}

function pick(v,a,item){
 const rt=performance.now()-window.__t;rts.push(rt);
 document.querySelectorAll('.opt').forEach(n=>{if(n.getAttribute('data-val')===a)n.classList.add('correct');if(n.getAttribute('data-val')===v&&v!==a)n.classList.add('wrong')});
 const ok=(v===a); if(MODE==='combat'){ if(!ok)combatMistTopics.push(item.topic)}
 if(ok)score++, pling();

 // slow topic?
 let avg = rts.reduce((x,y)=>x+y,0)/rts.length;
 if(rt > avg) combatSlowTopics.push(item.topic);

 if(MODE==='practice'){if(!isReview&&!ok)ensureMist(item.topic,item);else if(isReview)markReview(item.topic,item,ok);}
 setTimeout(()=>{i++;render()},120);
}

function confetti(){let l=$('confetti')||document.createElement('div');l.id='confetti';document.body.append(l);l.classList.remove('hidden');
const W=innerWidth,H=innerHeight;for(let k=0;k<120;k++){let d=document.createElement('div');d.className='conf';
d.style.left=Math.random()*W+'px';d.style.top='-20px';d.style.background=`hsl(${rand(0,360)},100%,60%)`;
let fall=H+80+Math.random()*200,time=1800+Math.random()*600,rot=(Math.random()*720-360);
d.animate([{transform:'translateY(0) rotate(0deg)'},{transform:`translateY(${fall}px) rotate(${rot}deg)`}],
{duration:time,easing:'cubic-bezier(.2,.6,.2,1)'});l.appendChild(d);setTimeout(()=>l.removeChild(d),time+60)}setTimeout(()=>l.classList.add('hidden'),2600)}

function end(){
 const acc=score/Math.max(1,total)*100,avg=rts.reduce((x,y)=>x+y,0)/Math.max(1,rts.length);
 if(MODE==='practice'){PCOUNT[TOPIC]++;savePCount();if(isReview){let keep=[],removed=0;
 for(let it of PMIST[TOPIC]){if((it.streak||0)>=2)removed++;else keep.push(it)}PMIST[TOPIC]=keep;savePMist();
 $('sumPracticeExtra').textContent=`Removed: ${removed}`;}else $('sumPracticeExtra').textContent='';}
 else{
 const bank=total-score;
 let slow=calcWeak(combatSlowTopics,0.5), err=calcWeak(combatMistTopics,0.4);
 let weak=[...new Set([...slow.map(t=>`â± ${t}`),...err.map(t=>`âœ– ${t}`)])];
 COMHIST.push({acc,avg,bank,weak});saveComHist();confetti();}

 $('sumLines').innerHTML=`Accuracy: ${acc.toFixed(0)}%<br>Avg Time: ${(avg/1000).toFixed(2)}s`;
 $('summaryButtons').innerHTML=MODE==='combat'
 ?`<button id="btnAgain" class="bigbtn">âš”ï¸ Another Battle</button>`
 :`<button id="btnAgain" class="bigbtn">ğŸ” Another Practice</button>`;
 $('btnAgain').onclick=()=>{$('summary').style.display='none';MODE==='combat'?startCombat(DIFF):startPractice(TOPIC)};
 $('summary').style.display='flex';drawSideHUD();
}

function calcWeak(list,threshold){
 let c=list.reduce((m,t)=>(m[t]=(m[t]||0)+1,m),{}),out=[];
 for(let t in c){if(c[t]/list.length>=threshold)out.push(topicName(t))}
 return out;
}
const topicName=t=>({m:"Multiplication",pow:"Exponents",root:"Roots",frac:"Fractions"})[t]||t;

document.body.insertAdjacentHTML("beforeend",`
<section id="lobby" class="center">
 <div class="card">
   <h2>Zen Dragon Trainer</h2>
   <button id="toCombat" class="bigbtn">âš”ï¸ Combat</button>
   <button id="toPractice" class="bigbtn">ğŸ“š Practice</button>
   <button id="btnHowTo" class="bigbtn">ğŸ“– Instructions</button>
 </div>
</section>

<section id="combatMenu" class="center hidden">
<div class="card">
<h3>Choose Battle Level</h3>
<button id="cEasy" class="btn">Easy</button>
<button id="cMed" class="btn">Medium <span id="medState" class="lock">(locked)</span></button>
<button id="cHard" class="btn">Hard <span id="hardState" class="lock">(locked)</span></button>
Length <select id="lenCombat"><option>10</option><option selected>20</option></select>
<br><button id="backFromCombat" class="btn">â¬… Back</button>
</div>
</section>

<section id="practiceMenu" class="center hidden">
<div class="card">
<h3>Select Topic</h3>
<button class="btn pTopic" data-topic="m">Multiplication</button>
<button class="btn pTopic" data-topic="pow">Exponents</button>
<button class="btn pTopic" data-topic="root">Roots</button>
<button class="btn pTopic" data-topic="frac">Fractions</button>
Length <select id="lenPractice"><option>20</option><option>30</option></select>
<br><button id="backFromPractice" class="btn">â¬… Back</button>
</div>
</section>

<section id="game" class="hidden">
<div id="side" class="card">
<div class="metric"><div class="label">Accuracy</div><div id="hudAcc" class="value">â€”</div></div>
<div class="metric"><div class="label">Avg Time</div><div id="hudSpd" class="value">â€”</div></div>
<div class="metric"><div class="label">Mistakes</div><div id="hudBank" class="value">â€”</div></div>
<div class="metric"><div class="label">Weak Topics</div><div id="hudWeak" class="value">â€”</div></div>
<div class="hint">Goal: 95% acc â€¢ â‰¤1.5s avg â€¢ â‰¤3 mistakes (last 3)</div>
</div>
<div class="card">
<div id="homeBtn" class="topSwitch">Home</div>
<h1 id="gameTitle">Zen Dragon</h1>
<div class="bar"><span id="barFill"></span></div>
<div id="startWrap"><button id="startBtn" class="bigbtn">Start Battle</button></div>
<div id="q" class="q" style="display:none">Ã—</div>
<div id="opts" class="options"></div>
<div id="progress" class="mini">0%</div>
</div>
</section>

<div id="summary" class="center">
 <div class="card">
   <h3>Session Report</h3>
   <div id="sumLines"></div>
   <div id="sumPracticeExtra"></div>
   <div id="summaryButtons"></div>
   <button id="btnHome" class="bigbtn">ğŸ  Home</button>
 </div>
</div>

<div id="howtoModal" class="center">
 <div class="card" style="max-width:700px;text-align:start">
 <button id="closeHowTo" class="btn" style="float:right">âœ–</button>
 <button id="toggleLang" class="btn" style="float:left">×¢×‘×¨×™×ª</button>
 <div style="clear:both"></div>
 <div id="howtoContent"></div>
 </div>
</div>
`);

const howtoHe = `
<h2>×”×¡×‘×¨×™</h2>
<b>××˜×¨×”:</b> ××™××•×Ÿ ××”×™×¨×•×ª, ×“×™×•×§ ×•×‘×™×˜×—×•×Ÿ ×‘×—×™×©×•×‘ ×‘×¨××©.<br><br>
âš”ï¸ <b>×§×¨×‘:</b> ×©××œ×•×ª ××›×œ ×”×ª×—×•××™× ×œ×¤×™ ×¨××”<br>
ğŸ“š <b>×ª×¨×’×•×œ:</b> × ×•×©× ××—×“ ×œ×¢×•××§ + ×ª×™×§×•×Ÿ ×˜×¢×•×™×•×ª<br><br>
<b>×™×¢×“×™× (×××•×¦×¢ 3 ×§×¨×‘×•×ª):</b><br>
âœ… ×“×™×•×§ â‰¥ 95%<br>
âœ… ×–××Ÿ â‰¤ 1.50 ×©× ×™×•×ª<br>
âœ… â‰¤ 3 ×˜×¢×•×™×•×ª<br><br>
<b>××™×š ××–×•×”×•×ª ×—×•×œ×©×•×ª?</b><br>
â± ××™×˜×™×•×ª: >50% ××”×©××œ×•×ª ××™×˜×™×•×ª ××”×××•×¦×¢<br>
âœ– ×©×’×™××•×ª: â‰¥40% ×˜×¢×•×™×•×ª ×‘×ª×—×•×<br><br>
××œ ×ª×™×¢×¦×¨ ×¢×œ ×©××œ×” â€” ×”××¢×¨×›×ª ×ª×—×–×™×¨ ××•×ª×š ××œ×™×” ×‘×©×œ×‘ ×”× ×›×•×Ÿ.
`;

const howtoEn = `
<h2>Instructions</h2>
<b>Goal:</b> train speed, accuracy & confidence in mental math.<br><br>
âš”ï¸ <b>Combat:</b> mixed questions by difficulty<br>
ğŸ“š <b>Practice:</b> focus on one topic + mistake reviews<br><br>
<b>Rank Up (avg of last 3 battles):</b><br>
âœ… Accuracy â‰¥ 95%<br>
âœ… Avg time â‰¤ 1.50s<br>
âœ… â‰¤ 3 mistakes<br><br>
<b>Weakness logic:</b><br>
â± Slow: >50% slower than battle avg<br>
âœ– Errors: â‰¥40% wrong in topic<br><br>
Donâ€™t freeze â€” flow, and the system will return weak topics automatically.
`;

let howtoLang='en';
function loadHowto(){ $('howtoContent').innerHTML = howtoLang==='en'?howtoEn:howtoHe;}

$('btnHowTo').onclick=()=>{$('howtoModal').style.display='flex';loadHowto()};
$('closeHowTo').onclick=()=>{$('howtoModal').style.display='none'};
$('toggleLang').onclick=()=>{howtoLang=howtoLang==='en'?'he':'en';loadHowto();$('toggleLang').textContent=howtoLang==='en'?'×¢×‘×¨×™×ª':'English'};

$('toCombat').onclick=()=>{MODE='combat';updateLevelBadge();show('combatMenu')};
$('toPractice').onclick=()=>{MODE='practice';show('practiceMenu')};
$('backFromCombat').onclick=()=>show('lobby');
$('backFromPractice').onclick=()=>show('lobby');
$('homeBtn').onclick=()=>show('lobby');
$('cEasy').onclick=()=>startCombat('easy');
$('cMed').onclick=()=>UNL.medium?startCombat('medium'):$('cMed').classList.add('shake');
$('cHard').onclick=()=>UNL.hard?startCombat('hard'):$('cHard').classList.add('shake');
document.querySelectorAll('.pTopic').forEach(b=>b.onclick=()=>startPractice(b.dataset.topic));
$('startBtn').onclick=()=>{ $('startWrap').style.display='none';$('q').style.display='block';render() };
$('btnHome').onclick=()=>{ $('summary').style.display='none';show('lobby') };

show('lobby');updateLevelBadge();drawSideHUD();
</script>

</body>
</html>
