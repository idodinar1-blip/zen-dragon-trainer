<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Zen Dragon v9.5 ‚Äî Neon Locks & Last‚Äë3 HUD</title>
<style>
:root{--bg:#0a0f1e;--glass:rgba(17,26,54,.65);--tx:#e8eeff;--n1:#5ee0ff;--n2:#8b5bff;--n3:#ff3f88;--good:#10b981;--bad:#ef4444}
*{box-sizing:border-box}body{margin:0;background:linear-gradient(180deg,#0a0f1e,#090e1c 60%);color:var(--tx);font-family:-apple-system,Segoe UI,Roboto,Arial;min-height:100vh}
.hidden{display:none!important}.center{display:flex;align-items:center;justify-content:center}
.card{background:var(--glass);border:1px solid rgba(255,255,255,.08);border-radius:16px;backdrop-filter:blur(6px);box-shadow:0 12px 40px rgba(0,0,0,.25)}
h1,h2,h3{margin:0 0 10px}
#lobby,#combatMenu,#practiceMenu{height:100vh}.box{max-width:720px;width:92%;padding:28px;text-align:center}
.bigbtn{padding:16px 22px;border-radius:14px;border:none;font-size:20px;font-weight:800;cursor:pointer;color:#fff;background:linear-gradient(90deg,var(--n2),var(--n3));margin:8px 0;width:100%}
.btn{position:relative;padding:14px 16px;border-radius:12px;border:1px solid #27345d;background:#111a36;color:var(--tx);font-weight:800;font-size:18px;cursor:pointer;transition:.15s}
.btn[disabled]{opacity:.45;cursor:not-allowed}
.badge{display:inline-flex;gap:8px;align-items:center;background:linear-gradient(90deg,#1a2246,#111a36);border:1px solid #223160;border-radius:999px;padding:8px 12px;margin-top:10px;font-size:13px}
.badge .ok{color:#9effc9}.badge .lock{color:#ffc36a}
/* Neon lock style (B) */
.lockedBtn{background:rgba(20,20,40,.6)!important;border-color:#3a2a6e!important;color:#9aa0c6!important;
  box-shadow:0 0 12px rgba(139,91,255,.55), inset 0 0 18px rgba(94,224,255,.12)}
.lockIcon{position:absolute;left:16px;top:50%;transform:translateY(-50%);font-size:20px;
  text-shadow:0 0 8px #8b5bff, 0 0 14px #5ee0ff}
.shake{animation:shake .35s cubic-bezier(.36,.07,.19,.97) 1}
@keyframes shake{10%,90%{transform:translateX(-1px)}20%,80%{transform:translateX(2px)}30%,50%,70%{transform:translateX(-4px)}40%,60%{transform:translateX(4px)}}
/* Game layout */
#game{display:grid;grid-template-columns:320px 1fr;gap:18px;padding:18px}
@media(max-width:900px){#game{grid-template-columns:1fr} #side{order:2}}
#side,#main{padding:16px}
.hudTitle{font-size:14px;letter-spacing:.12em;text-transform:uppercase;color:#bcd1ff;opacity:.9}
.metric{display:flex;align-items:center;justify-content:space-between;margin:14px 0}
.metric .label{font-size:16px;color:#cfe2ff;opacity:.9}
.metric .value{font-weight:900;font-size:22px;background:linear-gradient(90deg,var(--n1),var(--n2),var(--n3));-webkit-background-clip:text;color:transparent}
.hint{font-size:12px;color:#cfe2ff;opacity:.85;margin-top:8px}
.bar{height:10px;width:90%;max-width:700px;margin:8px auto;border-radius:999px;background:#0f1830;border:1px solid #23365f;overflow:hidden}
.bar>span{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--n1),var(--n2),var(--n3));transition:width .25s}
.q{font-size:64px;font-weight:900;margin:16px 0;background:linear-gradient(90deg,var(--n1),var(--n2),var(--n3));-webkit-background-clip:text;color:transparent;text-align:center}
.options{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:10px auto;max-width:760px}
.opt{background:rgba(255,255,255,.06);padding:22px;border-radius:14px;font-size:44px;font-weight:900;text-align:center;border:2px solid transparent;cursor:pointer;transition:.12s}
.opt.correct{background:rgba(16,185,129,.18);border-color:var(--good)}.opt.wrong{background:rgba(239,68,68,.18);border-color:var(--bad)}
.topSwitch{position:fixed;top:12px;right:12px;font-size:12px;padding:8px 12px;border-radius:10px;background:rgba(255,255,255,.12);backdrop-filter:blur(4px);cursor:pointer;z-index:5}
#startWrap{display:flex;align-items:center;justify-content:center;margin:20px 0}
#startBtn{padding:16px 22px;border-radius:14px;border:none;font-size:20px;font-weight:800;cursor:pointer;color:#fff;background:linear-gradient(90deg,var(--n1),var(--n3));}
#summary{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;backdrop-filter:blur(3px);z-index:40}
#sumBox{background:#0f1830;border:1px solid #27345d;border-radius:16px;padding:20px;max-width:680px;width:92%;text-align:center}
#confetti{position:fixed;inset:0;pointer-events:none;overflow:hidden;z-index:50}
.conf{position:absolute;width:10px;height:14px;opacity:.9;will-change:transform}
</style>
</head>
<body>

<!-- LOBBY -->
<section id="lobby" class="center">
  <div class="box card">
    <h2>Zen Dragon Trainer</h2>
    <p>Sharpen the mind. Train the warrior.</p>
    <button id="toCombat" class="bigbtn">‚öîÔ∏è Combat Mode</button>
    <button id="toPractice" class="bigbtn">üìö Practice Mode</button>
  </div>
</section>

<!-- COMBAT MENU -->
<section id="combatMenu" class="center hidden">
  <div class="box card">
    <h3>Choose your battle</h3>
    <div class="badge"><strong>Levels:</strong> Easy ‚Ä¢ Medium <span id="medState" class="lock">(locked)</span> ‚Ä¢ Hard <span id="hardState" class="lock">(locked)</span></div>
    <div style="margin-top:12px;display:grid;gap:10px">
      <button id="cEasy" class="btn">Easy</button>
      <button id="cMed" class="btn">Medium</button>
      <button id="cHard" class="btn">Hard</button>
    </div>
    <div style="margin-top:16px">Length: <select id="lenCombat"><option>10</option><option selected>20</option><option>30</option></select></div>
    <div style="margin-top:14px"><button id="backFromCombat" class="btn">‚¨ÖÔ∏è Back</button></div>
  </div>
</section>

<!-- PRACTICE MENU -->
<section id="practiceMenu" class="center hidden">
  <div class="box card">
    <h3>Pick a topic to practice</h3>
    <div style="margin-top:12px;display:grid;gap:10px">
      <button class="btn pTopic" data-topic="m">Multiplication</button>
      <button class="btn pTopic" data-topic="pow">Exponents</button>
      <button class="btn pTopic" data-topic="root">Roots</button>
      <button class="btn pTopic" data-topic="frac">Fractions</button>
    </div>
    <div style="margin-top:16px">Length: <select id="lenPractice"><option selected>20</option><option>30</option></select></div>
    <div style="margin-top:14px"><button id="backFromPractice" class="btn">‚¨ÖÔ∏è Back</button></div>
  </div>
</section>

<!-- GAME -->
<section id="game" class="hidden">
  <div id="side" class="card">
    <div class="hudTitle">COMBAT HUD</div>
    <div class="metric"><div class="label">Accuracy (avg of last 3)</div><div id="hudAcc" class="value">‚Äî</div></div>
    <div class="metric"><div class="label">Avg Time (avg of last 3)</div><div id="hudSpd" class="value">‚Äî</div></div>
    <div class="metric"><div class="label">Mistakes / battle (avg of last 3)</div><div id="hudBank" class="value">‚Äî</div></div>
    <div class="hint">Targets (measured by <b>average of last 3 battles</b>): Acc ‚â• <b>95%</b> ‚Ä¢ Avg ‚â§ <b>1.50s</b> ‚Ä¢ Mistakes ‚â§ <b>3</b>.</div>
  </div>
  <div id="main" class="card">
    <div id="homeBtn" class="topSwitch">Home</div>
    <h1 id="gameTitle">Zen Dragon</h1>
    <div class="bar"><span id="barFill"></span></div>
    <div id="startWrap"><button id="startBtn">Start Battle</button></div>
    <div id="q" class="q" style="display:none">√ó</div>
    <div id="opts" class="options"></div>
    <div id="progress" class="mini">0%</div>
  </div>
</section>

<!-- SUMMARY -->
<div id="summary" class="center">
  <div id="sumBox" class="card">
    <div style="font-weight:900">‚Äî‚Äî SESSION REPORT ‚Äî‚Äî</div><br/>
    <div id="sumLines"></div><br/>
    <div id="sumPracticeExtra" style="margin-bottom:10px;"></div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center">
      <button id="btnAgain" class="bigbtn">Another Battle</button>
      <button id="btnToPractice" class="bigbtn">Go to Practice Menu</button>
      <button id="btnHome" class="bigbtn">Go to Home</button>
    </div>
  </div>
</div>

<div id="confetti" class="hidden"></div>

<script>
/* ===== Helpers ===== */
function $(id){return document.getElementById(id)}
function show(el){['lobby','combatMenu','practiceMenu','game'].forEach(k=>$ (k).classList.add('hidden')); el.classList.remove('hidden')}
function pling(){try{let c=new (window.AudioContext||window.webkitAudioContext)(),o=c.createOscillator(),g=c.createGain();o.type='sine';o.frequency.value=880;g.gain.value=.0001;o.connect(g).connect(c.destination);o.start();g.gain.exponentialRampToValueAtTime(.15,c.currentTime+.01);g.gain.exponentialRampToValueAtTime(.0001,c.currentTime+.12);o.stop(c.currentTime+.13)}catch(e){}}

let MODE='combat', DIFF='easy', TOPIC='m', LENGTH=20;
let UNL=JSON.parse(localStorage.getItem('zenUnlocks')||'{"medium":false,"hard":false}');
function saveUnlocks(){localStorage.setItem('zenUnlocks',JSON.stringify(UNL))}
function updateLevelBadge(){
  // button visuals
  // Medium
  if(!UNL.medium){
    cMed.classList.add('lockedBtn');
    if(!cMed.querySelector('.lockIcon')){ let i=document.createElement('span'); i.className='lockIcon'; i.textContent='üîí'; cMed.prepend(i); }
  }else{
    cMed.classList.remove('lockedBtn');
    let i=cMed.querySelector('.lockIcon'); if(i) i.remove();
  }
  // Hard
  if(!UNL.hard){
    cHard.classList.add('lockedBtn');
    if(!cHard.querySelector('.lockIcon')){ let i=document.createElement('span'); i.className='lockIcon'; i.textContent='üîê'; cHard.prepend(i); }
  }else{
    cHard.classList.remove('lockedBtn');
    let i=cHard.querySelector('.lockIcon'); if(i) i.remove();
  }
  medState.textContent = UNL.medium ? '(unlocked)' : '(locked)';
  medState.className = UNL.medium ? 'ok' : 'lock';
  hardState.textContent = UNL.hard ? '(unlocked)' : '(locked)';
  hardState.className = UNL.hard ? 'ok' : 'lock';
}

/* ===== Pools (compact) ===== */
function rand(a,b){return Math.floor(Math.random()*(b-a+1))+a}
function mulPool(a,b){let out=[];a.forEach(x=>b.forEach(y=>out.push({t:`${x}√ó${y}`,a:String(x*y),topic:'m'})));return out}
function powPool(){let out=[];for(let n=1;n<=14;n++)out.push({t:`${n}¬≤`,a:String(n*n),topic:'pow'});for(let n=2;n<=6;n++)out.push({t:`${n}¬≥`,a:String(n*n*n),topic:'pow'});out.push({t:'2‚Å¥',a:'16',topic:'pow'},{t:'3‚Å¥',a:'81',topic:'pow'},{t:'2‚Åµ',a:'32',topic:'pow'},{t:'2‚Å∂',a:'64',topic:'pow'});return out}
function rootPool(){let out=[];[4,9,16,25,36,49,64,81,100,121,144,169,196].forEach(v=>out.push({t:`‚àö${v}`,a:String(Math.sqrt(v)),topic:'root'}));[8,27,64,125,216].forEach(v=>out.push({t:`¬≥‚àö${v}`,a:String(Math.cbrt(v)),topic:'root'}));[16,81].forEach(v=>out.push({t:`‚Å¥‚àö${v}`,a:String(Math.round(Math.pow(v,1/4))),topic:'root'}));out.push({t:'‚Åµ‚àö32',a:'2',topic:'root'},{t:'‚Å∂‚àö64',a:'2',topic:'root'});return out}
function fracPool(){let out=[];for(let k=0;k<14;k++){let a=rand(2,9),b=rand(2,9),c=rand(2,9);let n=a*b,d=a*c;let g=(m,n)=>{while(n){[m,n]=[n,m%n]}return Math.abs(m)};let gg=g(n,d);let simp=(n/gg)+'/'+(d/gg); if(d/gg==1)simp=String(n/gg); out.push({t:`${n}/${d}`,a:simp,topic:'frac'})}return out}
function pick4(ans,topic){let s=new Set([ans]);let num=parseFloat(ans);while(s.size<4){let g=String((isNaN(num)?rand(2,99):num+rand(-9,9))); if(g!==ans && g!=='NaN' && g!=='0')s.add(g)}return[...s].sort(()=>Math.random()-.5).map(v=>({v,topic}))}
function combatPool(d){let set=[];if(d==='easy'){set=[].concat(mulPool([2,3,4,5],[2,3,4,5,6]),powPool(),rootPool(),fracPool())}else if(d==='medium'){set=[].concat(mulPool([3,4,5,6,7],[4,5,6,7,8,9,10]),powPool(),rootPool(),fracPool())}else{set=[].concat(mulPool([6,7,8,9],[6,7,8,9,10]),powPool(),rootPool(),fracPool())}return set.sort(()=>Math.random()-.5)}
function practicePool(topic){let all=[].concat(combatPool('easy'),combatPool('medium'),combatPool('hard'));return all.filter(x=>x.topic===topic)}

/* ===== Data stores ===== */
let COMHIST=JSON.parse(localStorage.getItem('zenCombatSessions')||'[]');function saveComHist(){localStorage.setItem('zenCombatSessions',JSON.stringify(COMHIST.slice(-6)))}
let PMIST=JSON.parse(localStorage.getItem('zenPracticeMistakesV2')||'{"m":[],"pow":[],"root":[],"frac":[]}');function savePMist(){localStorage.setItem('zenPracticeMistakesV2',JSON.stringify(PMIST))}
let PCOUNT=JSON.parse(localStorage.getItem('zenPracticeCountsV2')||'{"m":0,"pow":0,"root":0,"frac":0}');function savePCount(){localStorage.setItem('zenPracticeCountsV2',JSON.stringify(PCOUNT))}

/* ===== HUD last‚Äë3 averages ===== */
function last3Stats(){
  let h=COMHIST.slice(-3);
  if(h.length===0) return {acc:null,avg:null,mist:null};
  let acc=h.reduce((s,x)=>s+(x.acc||0),0)/h.length;
  let avg=h.reduce((s,x)=>s+(x.avg||0),0)/h.length;
  let mist=h.reduce((s,x)=>s+(x.bank||0),0)/Math.max(1,h.length);
  return {acc,avg,mist};
}
function drawSideHUD(){
  if(MODE!=='combat') return;
  let s=last3Stats();
  hudAcc.textContent = (s.acc==null)?'‚Äî': s.acc.toFixed(0)+'%';
  hudSpd.textContent = (s.avg==null)?'‚Äî': (s.avg/1000).toFixed(2)+'s';
  hudBank.textContent= (s.mist==null)?'‚Äî': s.mist.toFixed(2);
}

/* ===== Game runtime ===== */
let qs=[],i=0,score=0,total=0,rts=[],isReview=false;
function resetRuntime(){i=0;score=0;rts=[]}
function beginBattle(){ $('startWrap').style.display='none'; $('q').style.display='block'; render() }
function startCombat(diff){ MODE='combat'; DIFF=diff; LENGTH=parseInt($('lenCombat').value||'20'); qs=combatPool(DIFF).slice(0,LENGTH); total=qs.length; $('gameTitle').textContent=`Combat ‚Äî ${diff[0].toUpperCase()+diff.slice(1)}`; enterGame(true) }
function startPractice(topic){ MODE='practice'; TOPIC=topic; LENGTH=parseInt($('lenPractice').value||'20'); let next=(PCOUNT[TOPIC]||0)+1; isReview=(next%3===0)&&(PMIST[TOPIC]||[]).length>0; let pool=isReview?PMIST[TOPIC].slice():practicePool(TOPIC).sort(()=>Math.random()-.5); qs=(pool.length>=LENGTH?pool.slice(0,LENGTH):pool.concat(practicePool(TOPIC)).slice(0,LENGTH)); total=qs.length; let map={m:'Multiplication',pow:'Exponents',root:'Roots',frac:'Fractions'}; $('gameTitle').textContent=isReview?`Practice ‚Äî ${map[TOPIC]} (Mistake Review)`: `Practice ‚Äî ${map[TOPIC]}`; enterGame(false) }
function enterGame(showSide){ show($('game')); $('side').style.display= showSide? 'block':'none'; $('barFill').style.width='0%'; $('progress').textContent='0%'; $('opts').innerHTML=''; $('q').style.display= showSide? 'none':'block'; $('startWrap').style.display= showSide? 'flex':'none'; resetRuntime(); drawSideHUD(); if(MODE==='practice') render(); }
function render(){ if(i>=total){end();return} const item=qs[i]; $('q').textContent=item.t; const ops=pick4(item.a,item.topic); $('opts').innerHTML=ops.map(o=>`<div class="opt" data-topic="${o.topic}" data-val="${o.v}">${o.v}</div>`).join(""); [...document.querySelectorAll('.opt')].forEach((el)=>{el.addEventListener('click',()=>pick(el.getAttribute('data-val'),item.a,item));}); $('barFill').style.width=(i/total*100)+'%'; $('progress').textContent=Math.round(i/total*100)+'%'; window.__t=performance.now(); }
document.addEventListener('keydown',e=>{if(['1','2','3','4'].includes(e.key)){let b=document.querySelectorAll('.opt')[parseInt(e.key)-1]; if(b) b.click();}});
function ensureMist(topic,item){PMIST[topic]=PMIST[topic]||[]; let idx=PMIST[topic].findIndex(x=>x.t===item.t&&x.a===item.a); if(idx===-1) PMIST[topic].push({t:item.t,a:item.a,streak:0}); savePMist()}
function markReview(topic,item,ok){let idx=PMIST[topic].findIndex(x=>x.t===item.t&&x.a===item.a); if(idx!==-1){PMIST[topic][idx].streak= ok ? (PMIST[topic][idx].streak||0)+1 : 0; savePMist()}}
function pick(v,a,item){ const rt=performance.now()-window.__t; rts.push(rt); const nodes=[...document.querySelectorAll('.opt')]; nodes.forEach(n=>{if(n.getAttribute('data-val')===a)n.classList.add('correct'); if(n.getAttribute('data-val')===v && v!==a)n.classList.add('wrong')}); const topic=item.topic; const ok=(v===a); if(ok){pling()} if(MODE==='practice'){ if(!isReview && !ok) ensureMist(topic,item); else if(isReview) markReview(topic,item,ok);} setTimeout(()=>{i++;render()},150) }
function confetti(){const layer=$('confetti'); layer.classList.remove('hidden'); const W=innerWidth,H=innerHeight; for(let k=0;k<160;k++){let d=document.createElement('div'); d.className='conf'; d.style.left=Math.random()*W+'px'; d.style.top='-20px'; d.style.background=`hsl(${Math.floor(Math.random()*360)},100%,60%)`; let fall=H+80+Math.random()*200,time=2200+Math.random()*800,rot=(Math.random()*720-360); d.animate([{transform:'translateY(0) rotate(0deg)'},{transform:`translateY(${fall}px) rotate(${rot}deg)`}],{duration:time,easing:'cubic-bezier(.2,.6,.2,1)'}); layer.appendChild(d); setTimeout(()=>layer.removeChild(d),time+60)} setTimeout(()=>layer.classList.add('hidden'),3100) }
function end(){ const acc=score/Math.max(1,total)*100; const avg = rts.reduce((x,y)=>x+y,0)/Math.max(1,rts.length); let removed=0; if(MODE==='practice'){ PCOUNT[TOPIC]=(PCOUNT[TOPIC]||0)+1; savePCount(); if(isReview){ let keep=[]; for(let it of (PMIST[TOPIC]||[])){ if((it.streak||0)>=2){ removed++; } else { keep.push(it) } } PMIST[TOPIC]=keep; savePMist(); $('sumPracticeExtra').textContent=`Removed from mistake bank: ${removed}. Rule: each mistake is deleted only after TWO correct answers in TWO separate reviews (with two normal sessions in between).`; } else { $('sumPracticeExtra').textContent='' } } else { // Combat
  const bankCount = total - score;
  COMHIST.push({acc:acc,avg:avg,bank:bankCount,ts:Date.now()}); saveComHist();
  $('sumPracticeExtra').textContent='';
  confetti();
  // Promotion by last-3 AVERAGES
  function last3Pass(){let h=COMHIST.slice(-3); if(h.length<3) return false; let A=h.reduce((s,x)=>s+x.acc,0)/3; let T=h.reduce((s,x)=>s+x.avg,0)/3; let M=h.reduce((s,x)=>s+x.bank,0)/3; return A>=95 && T<=1500 && M<=3}
  if(!UNL.medium && last3Pass()){UNL.medium=true; saveUnlocks()}
  else if(UNL.medium && !UNL.hard && last3Pass()){UNL.hard=true; saveUnlocks()}
 }
 // Update HUD with new last-3 averages
 drawSideHUD();
 $('sumLines').innerHTML=`Accuracy: ${acc.toFixed(0)}%<br>Avg Response: ${(avg/1000).toFixed(2)}s`;
 $('summary').style.display='flex';
}

/* ===== Nav bindings ===== */
toCombat.addEventListener('click',()=>{MODE='combat';updateLevelBadge();show(combatMenu)});
toPractice.addEventListener('click',()=>{MODE='practice';show(practiceMenu)});
backFromCombat.addEventListener('click',()=>show(lobby));
backFromPractice.addEventListener('click',()=>show(lobby));
homeBtn.addEventListener('click',()=>show(lobby));
cEasy.addEventListener('click',()=>startCombat('easy'));
cMed.addEventListener('click',()=>{
  if(UNL.medium){ startCombat('medium'); }
  else { cMed.classList.remove('shake'); void cMed.offsetWidth; cMed.classList.add('shake'); }
});
cHard.addEventListener('click',()=>{
  if(UNL.hard){ startCombat('hard'); }
  else { cHard.classList.remove('shake'); void cHard.offsetWidth; cHard.classList.add('shake'); }
});
document.querySelectorAll('.pTopic').forEach(b=>b.addEventListener('click',()=>startPractice(b.getAttribute('data-topic'))));
startBtn.addEventListener('click',beginBattle);
btnAgain.addEventListener('click',()=>{ summary.style.display='none'; startCombat(DIFF) });
btnToPractice.addEventListener('click',()=>{ summary.style.display='none'; show(practiceMenu) });
btnHome.addEventListener('click',()=>{ summary.style.display='none'; show(lobby) });

// boot
updateLevelBadge(); show(lobby); drawSideHUD();
</script>
</body>
</html>
